<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>exercise 2 - Gateway - HOMicS</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">HOMicS</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li >
                                <a href="../../setup/">Setup</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Exercises <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../monolith/">exercise 0 - Monolith</a>
</li>
                                    
<li >
    <a href="../user-activity/">exercise 1 - User Activity</a>
</li>
                                    
<li class="active">
    <a href="./">exercise 2 - Gateway</a>
</li>
                                    
<li >
    <a href="../stats/">exercise 3 - Stats</a>
</li>
                                    
<li >
    <a href="../kafka/">exercise 4 - Stats with Kafka</a>
</li>
                                    
<li >
    <a href="../stock/">exercise 5 - Stock</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../about/">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../user-activity/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../stats/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#exercise-2-gateway">Exercise 2 : Gateway</a></li>
            <li><a href="#context">Context</a></li>
            <li><a href="#goal">Goal</a></li>
            <li><a href="#at-your-keyboard">At your keyboard</a></li>
            <li><a href="#monolith-database">Monolith database</a></li>
            <li><a href="#verification">Verification</a></li>
            <li><a href="#whats-next-exercise-3-stats">What's next ? Exercise 3: Stats</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="exercise-2-gateway">Exercise 2 : Gateway</h1>
<p>Previously on HOMicS -&gt; <a href="../user-activity/">Exercise 1: User Activity</a></p>
<h2 id="context">Context</h2>
<p>In the previous schema, you might realize that there is a flaw. We don't have any authentication for the micro-service.</p>
<blockquote>
<p><img alt="question" src="../../img/question.png" /> What happens if you connect directly to the user-activity microservice ?</p>
</blockquote>
<p>You can go directly to <a href="http://localhost:9001/user/userActivity">user-activity</a>. The login page is skipped and the data
is accessible! Oopsy, not great at all.</p>
<p>We could duplicate all the security code in the new microservice. But imagine if we have 20 microservices, it's going
to be a mess if we need to add the security in each of them. The services won't be loosely coupled. It's where the
gateway becomes handy.</p>
<p>A gateway is a service that provides a single-entry point for certain groups of microservices. Any requests to our
application will go through the gateway.</p>
<h2 id="goal">Goal</h2>
<p>Create the <strong>Gateway</strong> microservice responsible for all authentication and redirection. It's going to handle the
authentication and redirect to the <strong>monolith</strong> or the <strong>user-activity</strong> microservice.</p>
<p><img alt="gateway" src="../../img/gateway.png" /></p>
<h2 id="at-your-keyboard">At your keyboard</h2>
<ol>
<li>
<p>Use the final version for <strong>user-activity</strong></p>
<pre><code># Checkout the branch final
user-activity$ git checkout final
# Compile the front and back
user-activity$ mvn clean install
# Run the user-activity microservice
user-activity$ mvn spring-boot:run
</code></pre>
<p>You won't need to change anything on user. You can leave it running on the side.</p>
</li>
<li>
<p>Setup the projects ... again</p>
<p>Let's change the branch for the <strong>monolith</strong>.</p>
<pre><code>monolith $ git checkout exo2-gateway
</code></pre>
<p>You can clone the repository for the gateway.</p>
<pre><code>git clone https://github.com/homics/gateway.git
</code></pre>
<p>Same as before, some <em>TODO</em> are left in the code that you will need to fill.</p>
<blockquote>
<p><img alt="warning" src="../../img/warning.png" /> I think you remember this but let's do it again: <code>mvn clean install</code> to compile the
front especially if you use an IDE. </p>
</blockquote>
</li>
<li>
<p>Application.yaml</p>
<p>There won't be any database for the gateway since it's not holding any data. It's going to be running on port 8080.</p>
<p>We are using <a href="https://github.com/Netflix/zuul">ZUUL</a> developed by Netflix that is an edge service that provides dynamic
routing, monitoring, resiliency, security, and more. Spring integrated it in <strong>Spring Cloud</strong>.</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-zuul&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>You will need to set it up in your <code>application.yaml</code>.</p>
<blockquote>
<p><img alt="tip" src="../../img/success.png" /> zuul documentation is available 
<a href="https://cloud.spring.io/spring-cloud-netflix/multi/multi__router_and_filter_zuul.html">here</a></p>
</blockquote>
</li>
<li>
<p>Update the <code>WebSecurityConfig</code></p>
<p>Check the configuration from the monolith. It should be quite identical. You might have to remove some <code>/mono</code>.</p>
</li>
<li>
<p>Move authentication</p>
<blockquote>
<p><img alt="question" src="../../img/question.png" /> You remember what the Gateway is all about?</p>
</blockquote>
<p>Security and authentication, yes!</p>
<p>You already worked on the security when you updated the <code>WebSecurityConfig</code>.</p>
<p>Let's take care of the authentication. Don't be afraid, you basically need to move your files from the monolith to
your gateway. Not too difficult.</p>
<p>Now, your <strong>Gateway</strong> is going to take care of the login and will send an event to <strong>user-activity</strong> when there is a successful
login or logout.</p>
</li>
<li>
<p>Logged user information</p>
<p>Last but not least, you need to add the logged user to the headers so all micro services will be able to retrieve the
connected user.</p>
<p>Open <code>AddUserFilter</code> and implement the <code>run</code> method so it adds the username into the request context.</p>
</li>
<li>
<p>Edit the <code>UserFilter</code> to retrieve this information in the <strong>monolith</strong>.</p>
</li>
</ol>
<blockquote>
<p><img alt="tip" src="../../img/success.png" /> Since the <strong>Gateway</strong> is running on port 8080, you need to change the port for the monolith to 8090. </p>
</blockquote>
<h2 id="monolith-database">Monolith database</h2>
<p>You can access the <strong>monolith</strong> database console via the following <a href="http://localhost:8090/console">url</a>.</p>
<h2 id="verification">Verification</h2>
<p>To verify that gateway is well implemented, launch all the applications:</p>
<pre><code class="bash"># Run monolith project
monolith$ mvn spring-boot:run

# Run user-activity project
user-activity$ mvn spring-boot:run

# Run Gateway project
gateway$ mvn spring-boot:run
</code></pre>

<p>Access the <a href="http://localhost:8080/login">HOMicS MarketPlace</a>. You should be on the gateway. After logging, you should be
directly redirect to the monolith and you can notify that the port is still 8080. You should be able to access as well
the user-activity microservice on the <em>User Activity micro</em> tab.</p>
<p><img alt="gateway-micro" src="../../img/gateway-micro.gif" /></p>
<blockquote>
<p><img alt="info" src="../../img/info.png" /> You can still access the other services directly on each port 8090 and 9001.
In practice, you will block those ports from the outside via a firewall.</p>
</blockquote>
<p>Well done. Let's continue on to the next step.</p>
<h2 id="whats-next-exercise-3-stats">What's next ? <a href="../stats/">Exercise 3: Stats</a></h2></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
