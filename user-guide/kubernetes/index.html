<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>exercise 7 - Kubernetes - HOMicS</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/purebasic.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">HOMicS</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li >
                                <a href="../../setup/">Setup</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Exercises <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../monolith/">exercise 0 - Monolith</a>
</li>
                                    
<li >
    <a href="../user-activity/">exercise 1 - User Activity</a>
</li>
                                    
<li >
    <a href="../gateway/">exercise 2 - Gateway</a>
</li>
                                    
<li >
    <a href="../stats/">exercise 3 - Stats</a>
</li>
                                    
<li >
    <a href="../kafka/">exercise 4 - Stats with Kafka</a>
</li>
                                    
<li >
    <a href="../stock/">exercise 5 - Stock</a>
</li>
                                    
<li >
    <a href="../containers/">exercise 6 - Containers</a>
</li>
                                    
<li class="active">
    <a href="./">exercise 7 - Kubernetes</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../troubleshooting/">Troubleshooting</a>
                            </li>
                            <li >
                                <a href="../../about/">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../containers/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../../troubleshooting/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#exercise-7-kubernetes">Exercise 7: Kubernetes</a></li>
            <li><a href="#context">Context</a></li>
            <li><a href="#setup">Setup</a></li>
            <li><a href="#goal">Goal</a></li>
            <li><a href="#at-your-keyboard">At your keyboard</a></li>
            <li><a href="#docker-commands">Docker commands :</a></li>
            <li><a href="#kube">Kube :</a></li>
            <li><a href="#get-logs">Get logs</a></li>
            <li><a href="#rolling-update">Rolling update</a></li>
            <li><a href="#db">DB</a></li>
            <li><a href="#trouble-shooting">Trouble shooting :</a></li>
            <li><a href="#good-to-know">Good to know</a></li>
            <li><a href="#whats-next">What's next ?</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="exercise-7-kubernetes">Exercise 7: Kubernetes</h1>
<p>Previously on HOMicS -&gt; <a href="../containers/">Exercise 6: Containers</a></p>
<h2 id="context">Context</h2>
<p>We saw on the previous exercises how to run our applications using containers and docker.</p>
<p>Maybe you noticed the <code>crash</code> button on user-activity tab. Surprisingly, this button will crash your application. It's 
our way to mock production crashes like OutOfMemory, StackOverflow, etc ... When it happens, you need to manually reboot
your container. In production, this is not acceptable.</p>
<p>Let's discover how Kubernetes can automatize this process.</p>
<h3 id="about-kube">About Kube</h3>
<p>// todo</p>
<h2 id="setup">Setup</h2>
<p>--&gt; present minikube</p>
<p>For macOS :
  $ brew cask install minikube
  Install virtual box</p>
<p>// todo</p>
<h2 id="goal">Goal</h2>
<p>Run our market place using kube.</p>
<h2 id="at-your-keyboard">At your keyboard</h2>
<p>Checkout the branch: </p>
<pre><code>git checkout exercise-7
</code></pre>
<p>1) le crah redemare le pod tout seul
2) Rolling update
3) pas d'update si la version ne passe pas les tests de vie</p>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-macos">Install and Set Up kubectl - Kubernetes</a></p>
<p>Install kubectl (via brew)</p>
<p>Install virtual box -&gt; brew cask install virtualbox
For Mac, don’t forget to authorize 
To install and/or use virtualbox you may need to enable its kernel extension in:
  System Preferences → Security &amp; Privacy → Generalbrew
then restart the installation.</p>
<p>Install Kube and minikube
<a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">Install Minikube - Kubernetes</a>
brew cask install minikube</p>
<h2 id="docker-commands">Docker commands :</h2>
<ol>
<li>mvn clean install spring-boot:repackage -Pcompile-front -pl "gateway"</li>
<li>docker build -t "handson/gateway:0.0.1-SNAPSHOT" "gateway"</li>
<li>docker run -d --rm --name "gateway" -p 8080:8080 "handson/gateway:0.0.1-SNAPSHOT"</li>
<li>docker stop gateway</li>
</ol>
<h2 id="kube">Kube :</h2>
<ol>
<li>minikube start</li>
<li>eval $(minikube docker-env)</li>
<li>docker build -t "handson/gateway:0.0.1-SNAPSHOT" "gateway"</li>
</ol>
<p>We need those two lines to set the docker images for minikube.</p>
<ol>
<li>kubectl apply -f deployment.yaml</li>
<li>kubectl apply -f service.yaml</li>
<li>minikube service gateway</li>
</ol>
<p>You can verify that everything is up by using <code>kubectl get deploy</code> or <code>pod</code> or <code>service</code>.</p>
<h2 id="get-logs">Get logs</h2>
<p>First get the pod name with : kubectl get pods
then get the logs : kubectl logs $POD_NAME</p>
<h2 id="rolling-update">Rolling update</h2>
<p>kubectl set image deployments/user-deployment user=handson/user-activity:0.0.2-SNAPSHOT</p>
<h2 id="db">DB</h2>
<p>dans database : kubectl create -f volume.yaml
kubectl get persistentvolumes</p>
<h2 id="trouble-shooting">Trouble shooting :</h2>
<p>If you enconter the error : invalid object doesn't have additional properties
you need to relink kubectl : brew link --overwrite kubernetes-cli</p>
<h2 id="good-to-know">Good to know</h2>
<p>// todo </p>
<h2 id="whats-next">What's next ?</h2>
<p>Come see us at our stand and let us know what you though about the Hands On.</p>
<p>Thank you. </p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
